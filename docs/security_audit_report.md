# ExecMCP 安全审计报告

- **版本**: 1.0
- **日期**: 2025-09-22
- **审计范围**: ExecMCP 服务端代码库（`internal/ssh`, `internal/execsvc`, `internal/security`, `internal/mcp`, `internal/config` 等关键模块）
- **审计目标**: 识别影响远程命令执行、凭据管理与访问控制的安全风险，给出修复优先级与落地建议。

## 执行摘要

本次审计共识别 9 项安全漏洞，其中 1 项为致命、3 项高危、3 项中危、2 项低危。最为紧迫的问题是 SSH 主机密钥校验被绕过，可能导致生产环境中的远程连接遭受中间人攻击；配合模板注入与目录逃逸问题，攻击者可进一步在受管主机上执行任意命令。建议在投入生产前完成高危以上问题的修复，并同步建立凭据保护、速率限制与安全审计日志等基础能力。

## 风险评估矩阵

| 严重级别 | 风险描述 | 影响范围 | 优先级 |
| --- | --- | --- | --- |
| 致命 (Critical) | 主机密钥校验被绕过，允许 MITM 劫持 SSH 连接 | 所有远程连接 | P0 立即修复 |
| 高危 (High) | 工作目录逃逸、模板命令注入、明文密码存储 | 命令执行路径、配置与凭据管理 | P0/P1 |
| 中危 (Medium) | ReDoS、信息泄露、参数校验缺失 | 安全过滤器、MCP 接口 | P1 |
| 低危 (Low) | 速率限制未实现、安全日志缺失 | 服务整体可观测性 | P2 |

## 漏洞详情

### 1. SSH 已知主机校验绕过（致命）

- **位置**: `internal/ssh/manager.go:205` (`getHostKeyCallback`)
- **状态**: ✅ 已修复
- **问题**: 当未配置或加载 known_hosts 失败时，代码直接退回 `ssh.InsecureIgnoreHostKey()`，导致生产环境连接无法验证主机身份。
- **影响**: 攻击者可伪造服务器响应、窃取或篡改命令输出，进一步植入恶意命令。
- **建议**:
  - 强制要求提供合法的 known_hosts；校验失败时立即拒绝连接并告警。
  - 为开发环境提供显式的 `allow_insecure_hostkey` 开关，默认关闭。
  - 补充单元测试覆盖缺失文件或损坏文件场景。

### 2. 工作目录白名单绕过（高危）

- **位置**: `internal/security/filter.go:259` (`isPathPrefix`)
- **状态**: ✅ 已修复（`isPathPrefix` 现对目标路径与白名单目录执行绝对路径解析、符号链接解析及 `filepath.Rel` 检查，阻断 `../`、符号链接逃逸等绕过方式）
- **修复摘要**:
  - 引入 `canonicalizePath` 与 `pathWithinPrefix`，使用 `filepath.Abs`、`filepath.EvalSymlinks` 和 `filepath.Rel` 判断目标目录是否实际位于白名单目录内。
  - 对相对路径先尝试直接校验，再与白名单目录拼接校验，防止合法相对路径被误拒。
  - 新增单元测试覆盖绝对路径、相对路径、`..` 绕过以及符号链接逃逸等场景，确保修复行为受测试保护。
- **后续建议**:
  - 结合远端主机的实际工作目录策略，评估是否需要对未能解析的路径进行显式拒绝或提示。
  - 持续扩展测试用例，覆盖不同操作系统及文件系统的边界情况。

### 3. 模板命令注入（高危）

- **位置**: `internal/execsvc/service.go:248` (`renderTemplate`)
- **状态**: ✅ 已修复（模板渲染现使用 `text/template`，默认对参数执行 shell 安全转义，并提供 `raw`/`shellQuote` 辅助函数；所有脚本执行路径统一接入新的渲染逻辑）
- **修复摘要**:
  - 采用标准库 `text/template` 渲染，启用自定义 `shellQuote` 逻辑，对 `UseShell` 脚本参数自动添加安全引号并转义单引号，阻断 `sh -c` 注入。
  - 新增测试专用 `Mock` SSH 管理器及模板辅助工具，重写 `internal/execsvc/service_test.go`/`stream_test.go`，覆盖正常渲染、默认值、缺参、流式执行等场景。
  - 暴露 `raw`/`shellQuote` 模板函数，保留在少数场景下输出原值或额外引用的能力，同时更新示例模板写法。
- **后续建议**:
  - 为模板参数引入类型/必填验证（`validateParameters` TODO），与新模板引擎结合进一步收紧输入面。
  - 梳理现有脚本模板，统一迁移为 `{{.param}}` 或 `{{shellQuote .param}}` 风格，避免历史脚本遗留不安全写法。

### 4. 明文存储 SSH 密码（高危）

- **位置**: `internal/config/config.go:31` 及 `applyEnvOverrides`
- **问题**: 密码以明文形式保存于配置文件和环境变量，缺乏脱敏与访问控制。
- **建议**:
  - 支持引用外部密钥管理系统（Vault、Secret Manager、OS Keychain 等），或至少支持文件/命令引用方式。
  - 加载配置时禁止将密码写入日志，内存中尽量缩短存活时间。
  - 增加凭据旋转流程与文档。

### 5. 可控正则导致 ReDoS（中危）

- **位置**: `internal/security/filter.go:67` & `:88`
- **问题**: 每次请求动态编译并执行来自配置的正则；若正则被恶意构造，可能触发指数级回溯，造成服务阻塞。
- **建议**:
  - 在配置加载阶段预编译正则并缓存；校验失败时阻止启动。
  - 引入执行超时（上下文控制）或采用保证线性时间的正则库。
  - 加入压力测试与基准测试评估极端输入。

### 6. 信息泄露（中危）

- **位置**: `internal/mcp/mcp_server.go:349`、`:396`
- **问题**: `handleTestConnection` 与 `handleListHosts` 对外返回主机地址、用户名、私钥路径等敏感信息。
- **建议**:
  - 对敏感接口增加认证/授权校验，或限定仅内部使用。
  - 回应中脱敏凭据路径，仅提供必要的状态信息。
  - 将访问尝试写入安全审计日志。

### 7. 输入校验缺失（中危）

- **位置**: `internal/execsvc/service.go:284` (`validateParameters` TODO)
- **问题**: 参数校验函数未实现，`required`、`type`、`validation` 字段未生效，导致非法参数进入模板渲染。
- **建议**:
  - 实现参数 schema 校验：必填检查、类型断言、正则约束、默认值回填。
  - 更新配置文档，说明参数类型与校验规则。
  - 引入单元测试覆盖缺参、类型不符、正则不匹配等场景。

### 8. 速率限制未落地（低危）

- **位置**: `internal/config/config.go:57` 及业务层
- **问题**: 配置项 `RateLimitPerMin` 仅存在于配置结构体，实际未在服务或过滤器中使用。
- **建议**:
  - 在 MCP 工具调用入口增加基于 host / 用户 / IP 的令牌桶限流。
  - 对限流事件记录日志并返回明确错误码。
  - 编写集成测试验证正常调用与被限流场景。

### 9. 安全日志与审计缺失（低危）

- **位置**: `internal/execsvc/service.go`、`internal/mcp/mcp_server.go`
- **问题**: 当前日志多为功能日志，缺少安全事件（拒绝、异常参数、凭据访问等）的集中记录，难以满足事后分析需求。
- **建议**:
  - 设计统一的安全事件日志格式（含请求 ID、操作者、触发规则等）。
  - 输出到独立频道或安全日志文件，保留足够的保留期。
  - 与监控/告警系统集成。

## 修复路线与优先级

1. **P0（立即）**
   - 移除 `ssh.InsecureIgnoreHostKey()` 回退路径，完成主机密钥强校验与告警。
   - 替换模板渲染逻辑并实现参数校验，阻断命令注入。
   - 修复目录白名单逻辑，新增回归测试。

2. **P1（1~2 周内）**
   - 引入凭据管理方案，迁移明文密码存储。
   - 预编译并托管正则表达式，加入超时保护。
   - 对 MCP 敏感接口增加鉴权与脱敏处理。

3. **P2（2~4 周）**
   - 实现速率限制与安全事件日志。
   - 完善监控告警与运维手册，定期演练。

## 代码与配置强化建议

- 在配置加载阶段执行安全校验（例如必填字段、路径合法性、密钥存在性），失败时阻止进程启动。
- 引入集中化的错误信息策略：对外返回泛化消息，对内日志记录详细上下文。
- 为 SSH 与脚本执行模块添加安全基线测试（lint、静态分析、shellcheck）。
- 加入依赖升级计划，定期审计 `golang.org/x/crypto/ssh` 等关键依赖。

## 测试与验证建议

- **单元测试**: `isPathPrefix`、模板渲染、参数校验、正则编译失败等核心分支。
- **集成测试**: 模拟被拒绝命令/参数、并发速率限制、凭据失效等场景。
- **安全测试**: 进行渗透模拟（MITM、命令注入、路径遍历）、Fuzz 过滤器输入、压力测试评估 ReDoS 修复效果。
- **验收标准**: 高危及以上漏洞均有自动化回归用例覆盖；关键修复需在预生产环境通过双人复核。

## 后续工作

- 制定安全修复里程碑与负责人，纳入迭代排期。
- 建立安全缺陷登记与追踪流程，确保闭环处理。
- 完善运维文档与培训材料，提升团队对安全基线的认知与响应速度。
