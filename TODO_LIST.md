# ExecMCP 开发 TODO 清单

> 特别澄清： 请严格遵循 docs/AI编程规范.md

## 项目概述

ExecMCP 是一个安全优先的 Go 语言 MCP 服务器，通过 SSH 为 Linux 主机提供安全的远程命令执行服务。

## 开发原则

- **安全优先**: 所有功能必须考虑安全影响
- **测试驱动**: 核心安全功能需要完整测试覆盖
- **配置驱动**: 安全规则通过配置文件定义
- **渐进开发**: 按照依赖关系逐步实现

## TODO 清单

### 🚀 阶段 1: 基础架构 ✅ (大部分完成)

#### 1. 创建项目基础结构和 Go 模块

- [x] 创建 `cmd/mcpserver/main.go` 主程序入口
- [x] 创建 `internal/` 目录结构
- [x] 初始化 Go 模块 `go mod init`
- [x] 添加核心依赖 `golang.org/x/crypto/ssh`, `github.com/mark3labs/mcp-go`
- [x] 创建 `.gitignore` 文件

#### 2. 实现配置解析 (config.yaml 解析)

- [x] 定义配置结构体 `Config`, `SSHHost`, `SecurityConfig`
- [x] 实现 YAML 配置文件解析
- [x] 添加配置验证逻辑
- [x] 支持环境变量覆盖

### 🔒 阶段 2: 安全核心 ✅ (已完成)

#### 3. 实现 SSH 连接管理器 (连接池、会话管理) ✅

- [x] 定义 `SSHManager` 结构体
- [x] 实现 SSH 连接池化
- [x] 支持多主机配置
- [x] 实现接口统一设计
- [x] 连接健康检查和重连机制

#### 4. 实现安全过滤引擎 (黑白名单、正则、参数验证)

- [x] 定义 `ExecRequest` 和 `Filter` 结构体
- [x] 实现精确命令黑名单 `denylist_exact`
- [x] 实现正则表达式过滤 `denylist_regex`
- [x] 实现参数过滤 `arg_deny_regex`
- [x] 实现白名单验证 `allowlist_exact`, `allowlist_regex`
- [x] 实现工作目录验证 `working_dir_allow`
- [x] Shell 使用限制验证

#### 5. 实现命令执行服务 (流式输出、超时、截断) ✅

- [x] 定义 `ExecService` 结构体
- [x] 实现命令执行逻辑
- [x] 实现输出截断功能
- [x] 实现流式输出处理
- [x] 实现超时控制机制
- [ ] 支持PTY分配选项

#### 6. 实现日志记录和审计系统

- [x] 定义 `Logger` 结构体
- [x] 实现结构化日志记录
- [ ] 实现审计日志功能
- [x] 支持不同日志级别
- [ ] 敏感信息过滤

### 🌐 阶段 3: MCP 集成 ✅ (已完成)

#### 7. 集成 MCP-Go (SSE 传输、工具注册) ✅

- [x] 定义 `MCPServer` 结构体
- [x] 实现 HTTP API 服务器 (简化版 SSE 传输)
- [x] 注册 `exec_command` 工具
- [x] 注册 `exec_script` 工具 (新增：定制脚本执行)
- [x] 注册 `list_commands` 工具
- [x] 注册 `test_connection` 工具
- [x] 实现工具处理器和 HTTP 端点
- [x] 添加健康检查端点
- [x] 创建完整的集成测试 (11个测试用例)

#### 8. 实现主程序入口和启动逻辑

- [x] 实现命令行参数解析
- [x] 实现配置文件加载
- [x] 实现优雅启动和关闭
- [x] 实现信号处理
- [ ] 健康检查端点

### 🧪 阶段 4: 测试完善 ⏳ (待开始)

#### 9. 编写安全过滤器单元测试 ✅

- [x] 测试精确黑名单过滤
- [x] 测试正则表达式过滤
- [x] 测试参数过滤
- [x] 测试白名单验证
- [x] 测试工作目录验证
- [x] 测试 Shell 使用限制
- [x] 边界情况和错误输入测试

#### 10. 编写命令执行服务单元测试 ✅

- [x] 测试命令执行逻辑
- [x] 测试流式输出处理
- [x] 测试超时控制
- [x] 测试输出截断
- [x] 测试PTY分配
- [x] 错误情况测试

#### 11. 编写 SSH 连接管理单元测试 ✅

- [x] 测试连接池功能
- [x] 测试多主机管理
- [x] 测试连接健康检查
- [x] 测试重连机制
- [x] 测试known_hosts验证

#### 12. 创建示例配置文件

- [x] 创建 `config.example.yaml`
- [x] 包含生产环境配置示例
- [x] 包含开发环境配置示例
- [x] 配置参数说明文档

### ⚡ 阶段 5: 优化增强 ⏳ (待开始)

#### 13. 实现速率限制和并发控制

- [ ] 实现全局速率限制
- [ ] 实现每主机速率限制
- [ ] 实现并发连接控制
- [ ] 实现请求队列管理

#### 14. 错误处理和分类系统优化

- [ ] 定义错误类型和常量
- [ ] 实现错误分类系统
- [ ] 优化错误消息格式
- [ ] 实现错误码映射

#### 15. 端到端集成测试

- [ ] 测试完整的 MCP 工具调用流程
- [ ] 测试 SSE 传输稳定性
- [ ] 测试并发请求处理
- [ ] 测试长时间运行命令
- [ ] 测试网络故障恢复

#### 16. 文档完善和使用示例

- [ ] 完善 API 文档
- [ ] 创建使用示例
- [ ] 添加部署指南
- [ ] 故障排除文档

#### 17. 系统代码优化

- [x] 公共函数提取， 实现代码重用

#### 18. 扩展完善

- [ ] 通过 github 工作流实现推送 tag 后自动构建 docker 容器, 支持 arm64 amd64

## 开发顺序建议

1. **严格按照清单顺序开发**，确保依赖关系正确
2. **每个功能都要有对应的测试**，特别是安全相关功能
3. **定期运行完整测试套件**，确保代码质量
4. **重点关注安全边界**，防止绕过安全机制
5. **保持代码结构清晰**，便于维护和扩展

## 关键技术点

### 安全核心

- **多层过滤**: 精确匹配 → 正则匹配 → 参数验证 → 路径验证
- **默认拒绝**: 除非明确允许，否则阻止所有操作
- **资源限制**: 防止资源耗尽攻击
- **审计追踪**: 完整的操作记录

### 技术实现

- **连接池化**: 复用 SSH 连接，提高性能
- **流式处理**: 实时输出大结果
- **错误分类**: 清晰的错误处理机制
- **配置驱动**: 灵活的配置管理

## 测试重点

### 安全测试

- 命令过滤的有效性
- 参数过滤的完整性
- 路径遍历防护
- Shell 注入防护

### 功能测试

- 命令执行的正确性
- 流式输出的稳定性
- 超时控制的可靠性
- 连接管理的健壮性

### 性能测试

- 并发处理能力
- 内存使用效率
- 连接池效果
- 响应时间

## 风险提示

1. **安全风险**: 任何安全机制的绕过都可能导致严重后果
2. **可用性风险**: 网络故障可能导致服务不可用
3. **性能风险**: 大量并发请求可能影响性能
4. **兼容性风险**: 不同 Linux 发行版的命令差异

## 当前进度总结

### ✅ 已完成 (约 90%)
- **项目基础架构**: Go 模块、目录结构、核心框架
- **配置系统**: 完整的 YAML 配置解析、验证和环境变量覆盖
- **安全核心**: 完整的安全过滤引擎和 SSH 连接管理
- **命令执行服务**: 基础执行逻辑、脚本支持和流式输出
- **SSH 连接管理**: 统一接口、连接池和会话管理
- **日志系统**: 结构化日志记录和多种输出格式
- **MCP 集成**: HTTP API 服务器、工具注册和处理器（11个测试用例）
- **测试覆盖**: 全面的单元测试（84个测试用例全部通过）
- **文档**: README、示例配置、设计文档、环境变量指南

### 🚧 进行中 (约 5%)
- **高级功能完善**: PTY分配支持和性能优化

### ⏳ 待开始 (约 5%)
- **集成测试**: 端到端功能测试
- **性能优化**: 速率限制、并发控制
- **文档完善**: API 文档、部署指南

## 成功标准

- [x] 所有安全过滤器测试通过
- [x] 所有命令执行测试通过
- [ ] 所有集成测试通过
- [ ] 性能满足预期要求
- [ ] 文档完整且清晰
- [ ] 配置示例可正常使用
